<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø–æ–∫—É–ø–∫–∞–º</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    {% load static %}
    <link rel="stylesheet" href="{% static 'backend/assistant.css' %}">
</head>
<body>
    <div class="assistant-container">
        <div class="header-nav">
            <div class="nav-left">
                <a href="/customer-products/" class="btn-primary"><i class="fas fa-home"></i> –í–µ—Ä–Ω—É—Ç—å—Å—è –Ω–∞ –≥–ª–∞–≤–Ω—É—é</a>
            </div>
            <div class="nav-right">
                <a href="/orders/" class="btn-primary"><i class="fas fa-clipboard-list"></i> –ú–æ–∏ –∑–∞–∫–∞–∑—ã</a>
                <a href="/basket/" class="btn-primary">
                    <i class="fas fa-shopping-cart"></i> –ö–æ—Ä–∑–∏–Ω–∞ <span id="basket-counter">0</span>
                </a>
            </div>
        </div>

        <div class="chat-header">
            <h2>üõçÔ∏è AI-–ê—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –ø–æ–∫—É–ø–∫–∞–º</h2>
            <p>–û–ø–∏—à–∏—Ç–µ, —á—Ç–æ –≤—ã –∏—â–µ—Ç–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "–ü–æ–¥–∞—Ä–æ–∫ –Ω–∞ 8 –º–∞—Ä—Ç–∞ –¥–æ 5000 ‚ÇΩ", "–ü–æ–¥–±–µ—Ä–∏ —Ç–æ–≤–∞—Ä—ã –¥–ª—è —Å–ø–æ—Ä—Ç–∞" –∏–ª–∏ "–ù–∞–π–¥–∏ —Ç–æ–≤–∞—Ä—ã –∫ —á–∞—é")</p>
        </div>

        <div class="chat-wrapper">
            <div class="chat-window" id="chatWindow">
                <div class="message assistant">
                    <p>–ü—Ä–∏–≤–µ—Ç, –º–µ–Ω—è –∑–æ–≤—É—Ç –ö–æ–Ω—Å—Ç–∞–Ω—Ç–∏–Ω! –Ø AI-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç, –∏ –ø–æ–º–æ–≥—É —Ç–µ–±–µ –±—ã—Å—Ç—Ä–æ –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –ø–æ —Ç–≤–æ–µ–º—É –∑–∞–ø—Ä–æ—Å—É. –ß—Ç–æ –≤—ã –∏—â–µ—Ç–µ?</p>
                </div>
            </div>

            <div class="input-area">
                <input type="text" id="userInput" placeholder="–í–∞—à –∑–∞–ø—Ä–æ—Å" autofocus>
                <button id="sendButton"><i class="fas fa-paper-plane"></i></button>
            </div>
        </div>

        <div class="products-grid" id="productsGrid">
            <!-- –¢–æ–≤–∞—Ä—ã –±—É–¥—É—Ç –∑–¥–µ—Å—å -->
        </div>
    </div>

    <script>
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è CSRF —Ç–æ–∫–µ–Ω–∞
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã
        function updateBasketCounter() {
            const token = localStorage.getItem("token");
            if (!token) return;

            fetch("/api/basket/", {
                method: "GET",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Token ${token}`
                }
            })
            .then(response => response.json())
            .then(data => {
                const basketCounter = document.getElementById("basket-counter");
                if (basketCounter) {
                    basketCounter.textContent = data.items.length;
                }
            })
            .catch(error => console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—á–µ—Ç—á–∏–∫–∞ –∫–æ—Ä–∑–∏–Ω—ã:", error));
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ –∫–æ—Ä–∑–∏–Ω—É
        function addToBasket(productId) {
            const token = localStorage.getItem("token");
            if (!token) {
                alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∞–≤—Ç–æ—Ä–∏–∑—É–π—Ç–µ—Å—å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –≤ –∫–æ—Ä–∑–∏–Ω—É.");
                window.location.href = "/login/";
                return;
            }

            const data = {
                product_info_id: productId,
                quantity: 1
            };

            fetch("/api/basket/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "Authorization": `Token ${token}`,
                    "X-CSRFToken": getCookie("csrftoken")
                },
                body: JSON.stringify(data)
            })
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –≤ –∫–æ—Ä–∑–∏–Ω—É.");
                }
            })
            .then(data => {
                if (data.Status === true && data.Message === "–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ") {
                    alert("–≠—Ç–æ—Ç —Ç–æ–≤–∞—Ä —É–∂–µ –≤ –∫–æ—Ä–∑–∏–Ω–µ.");
                } else {
                    alert("–¢–æ–≤–∞—Ä –¥–æ–±–∞–≤–ª–µ–Ω –≤ –∫–æ—Ä–∑–∏–Ω—É!");
                    updateBasketCounter();
                }
            })
            .catch(error => {
                alert(error.message);
            });
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —á–∞—Ç–∞
        document.addEventListener("DOMContentLoaded", function() {
            const chatWindow = document.getElementById("chatWindow");
            const userInput = document.getElementById("userInput");
            const sendButton = document.getElementById("sendButton");
            const productsGrid = document.getElementById("productsGrid");

            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫ –∫–æ—Ä–∑–∏–Ω—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
            updateBasketCounter();

            function addMessage(text, isUser) {
                const messageDiv = document.createElement("div");
                messageDiv.className = `message ${isUser ? "user" : "assistant"}`;

                // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–ª–∏–Ω—É —Å–æ–æ–±—â–µ–Ω–∏—è
                const maxLength = 60;
                const displayText = text.length > maxLength ? text.substring(0, maxLength) + "..." : text;

                messageDiv.innerHTML = `<p>${displayText}</p>`;
                chatWindow.appendChild(messageDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
            }

            function showLoading() {
                const loadingDiv = document.createElement("div");
                loadingDiv.className = "message assistant loading-message";
                loadingDiv.innerHTML = "<p><i class='fas fa-spinner fa-spin'></i> –ò—â—É —Ç–æ–≤–∞—Ä—ã...</p>";
                chatWindow.appendChild(loadingDiv);
                chatWindow.scrollTop = chatWindow.scrollHeight;
                return loadingDiv;
            }

            function showProducts(products) {
                productsGrid.innerHTML = '';

                if (!products || products.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="no-products">
                            <p>–ö —Å–æ–∂–∞–ª–µ–Ω–∏—é, –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.</p>
                        </div>
                    `;
                    return;
                }

                products.forEach(product => {
                    const productCard = document.createElement("div");
                    productCard.className = "product-card";

                    productCard.innerHTML = `
                        <div class="product-image">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <div class="product-info">
                            <h4 class="product-name">${product.product_name}</h4>
                            <div class="product-price">${product.price.toLocaleString('ru-RU')} ‚ÇΩ</div>
                            <div class="product-shop">${product.shop}</div>
                            <button onclick="addToBasket(${product.id})" class="add-to-cart">
                                <i class="fas fa-cart-plus"></i> –í –∫–æ—Ä–∑–∏–Ω—É
                            </button>
                        </div>
                    `;

                    productsGrid.appendChild(productCard);
                });
            }

            sendButton.addEventListener("click", async function() {
                const query = userInput.value.trim();
                if (!query) return;

                addMessage(query, true);
                userInput.value = "";
                const loadingDiv = showLoading();

                try {
                    const response = await fetch("/api/assistant/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken")
                        },
                        body: JSON.stringify({ query: query })
                    });

                    const data = await response.json();
                    loadingDiv.remove();

                    if (data.products && data.products.length > 0) {
                        addMessage(`–ù–∞–π–¥–µ–Ω–æ ${data.products.length} –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤:`, false);
                        showProducts(data.products);
                    } else {
                        addMessage("–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å –∑–∞–ø—Ä–æ—Å.", false);
                    }
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞:", error);
                    loadingDiv.innerHTML = "<p>–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.</p>";
                }
            });

            // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ Enter
            userInput.addEventListener("keypress", function(e) {
                if (e.key === "Enter") {
                    sendButton.click();
                }
            });
        });
    </script>
</body>
</html>
